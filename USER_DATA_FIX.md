# ç”¨æˆ·æ•°æ®è·å–å¤±è´¥é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

åœ¨ä¿®å¤ Next.js å¼€å‘å·¥å…·é”™è¯¯çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼š

```
æŠ‘åˆ¶Next.jså¼€å‘å·¥å…·é”™è¯¯: ç”¨æˆ·æ•°æ®è·å–å¤±è´¥:
```

è™½ç„¶ Next.js å¼€å‘å·¥å…·é”™è¯¯è¢«æˆåŠŸæŠ‘åˆ¶ï¼Œä½†å‡ºç°äº†ç”¨æˆ·æ•°æ®è·å–å¤±è´¥çš„é—®é¢˜ã€‚

## é—®é¢˜åˆ†æ

### é”™è¯¯æ¥æºï¼š

1. **æ•°æ®åº“å¥åº·æ£€æŸ¥**ï¼š

   - `useStableUser` hook ä¸­åŒ…å«äº†æ•°æ®åº“å¥åº·æ£€æŸ¥
   - å¥åº·æ£€æŸ¥å¯èƒ½å¤±è´¥å¹¶å½±å“ç”¨æˆ·æ•°æ®è·å–
   - æ£€æŸ¥è¿‡ç¨‹å¯èƒ½äº§ç”Ÿä¸å¿…è¦çš„é”™è¯¯

2. **é”™è¯¯å¤„ç†é€»è¾‘**ï¼š

   - åŸæœ‰çš„é”™è¯¯å¤„ç†è¿‡äºå¤æ‚
   - æ²¡æœ‰åŒºåˆ†ç½‘ç»œé”™è¯¯å’Œåº”ç”¨é”™è¯¯
   - æ‰€æœ‰é”™è¯¯éƒ½è¢«è®°å½•ä¸º"ç”¨æˆ·æ•°æ®è·å–å¤±è´¥"

3. **React Query é…ç½®**ï¼š
   - é‡è¯•æ¬¡æ•°è¿‡å¤šå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜
   - é”™è¯¯å¤„ç†ç­–ç•¥ä¸å¤Ÿçµæ´»

## ä¿®å¤æ–¹æ¡ˆ

### 1. ç§»é™¤æ•°æ®åº“å¥åº·æ£€æŸ¥

**é—®é¢˜**ï¼šæ•°æ®åº“å¥åº·æ£€æŸ¥å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é”™è¯¯
**è§£å†³**ï¼šä»ç”¨æˆ·æ•°æ®è·å–æµç¨‹ä¸­ç§»é™¤å¥åº·æ£€æŸ¥

```typescript
// ä¿®å¤å‰
const dbHealth = await checkDatabaseHealthFromClient()
if (dbHealth.status !== 'healthy') {
  console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¼‚å¸¸:', dbHealth.message)
}

// ä¿®å¤å
// ç§»é™¤æ•°æ®åº“å¥åº·æ£€æŸ¥ï¼Œç›´æ¥è·å–ç”¨æˆ·æ•°æ®
// æ•°æ®åº“å¥åº·æ£€æŸ¥å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é”™è¯¯
```

### 2. æ”¹è¿›é”™è¯¯å¤„ç†é€»è¾‘

**é—®é¢˜**ï¼šæ‰€æœ‰é”™è¯¯éƒ½è¢«ç»Ÿä¸€å¤„ç†
**è§£å†³**ï¼šåŒºåˆ†ç½‘ç»œé”™è¯¯å’Œåº”ç”¨é”™è¯¯

```typescript
// ä¿®å¤å‰
} catch (error) {
  console.error('âŒ ç”¨æˆ·æ•°æ®è·å–å¤±è´¥:', error)
  return null
}

// ä¿®å¤å
} catch (error) {
  console.error('âŒ ç”¨æˆ·æ•°æ®è·å–å¤±è´¥:', error)

  // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æ•°æ®åº“è¿æ¥é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨ç¼“å­˜æ•°æ®
  if (error instanceof Error) {
    const errorMessage = error.message.toLowerCase()
    if (errorMessage.includes('network') ||
        errorMessage.includes('connection') ||
        errorMessage.includes('timeout') ||
        errorMessage.includes('fetch')) {
      console.warn('âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨ç¼“å­˜æ•°æ®')
      return null // è®© React Query ä½¿ç”¨ç¼“å­˜æ•°æ®
    }
  }

  // å¯¹äºå…¶ä»–é”™è¯¯ï¼Œä¹Ÿè¿”å› null ä½¿ç”¨ç¼“å­˜æ•°æ®
  return null
}
```

### 3. ä¼˜åŒ– React Query é…ç½®

**é—®é¢˜**ï¼šé‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜
**è§£å†³**ï¼šå‡å°‘é‡è¯•æ¬¡æ•°ï¼Œä¼˜åŒ–é…ç½®

```typescript
// ä¼˜åŒ–åçš„é…ç½®
retry: (failureCount, error) => {
  // å‡å°‘é‡è¯•æ¬¡æ•°ï¼Œé¿å…è¿‡å¤šçš„å¼‚æ­¥æ“ä½œ
  return failureCount < 1
},
retryDelay: 1000, // å›ºå®šé‡è¯•å»¶è¿Ÿ
refetchOnWindowFocus: false, // çª—å£èšç„¦æ—¶ä¸é‡æ–°è·å–
refetchOnMount: false, // ç»„ä»¶æŒ‚è½½æ—¶ä¸é‡æ–°è·å–ï¼ˆå¦‚æœæ•°æ®ä»ç„¶æ–°é²œï¼‰
refetchOnReconnect: false, // ç½‘ç»œé‡è¿æ—¶ä¸é‡æ–°è·å–ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
```

## ä¿®å¤æ•ˆæœ

### 1. é”™è¯¯åˆ†ç±»å¤„ç†

- âœ… **ç½‘ç»œé”™è¯¯**ï¼šè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
- âœ… **åº”ç”¨é”™è¯¯**ï¼šæ­£å¸¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
- âœ… **æ•°æ®åº“é”™è¯¯**ï¼šä¸å½±å“ç”¨æˆ·æ•°æ®è·å–

### 2. æ€§èƒ½ä¼˜åŒ–

- âœ… **å‡å°‘é‡è¯•**ï¼šé¿å…è¿‡å¤šçš„å¼‚æ­¥æ“ä½œ
- âœ… **ç¼“å­˜ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨ç¼“å­˜æ•°æ®
- âœ… **æŒ‰éœ€è·å–**ï¼šåªåœ¨å¿…è¦æ—¶é‡æ–°è·å–æ•°æ®

### 3. ç”¨æˆ·ä½“éªŒ

- âœ… **æ— é”™è¯¯å¹²æ‰°**ï¼šç½‘ç»œé—®é¢˜ä¸å½±å“ç”¨æˆ·ç•Œé¢
- âœ… **å¿«é€Ÿå“åº”**ï¼šä½¿ç”¨ç¼“å­˜æ•°æ®æä¾›å¿«é€Ÿå“åº”
- âœ… **ç¨³å®šè¿è¡Œ**ï¼šå‡å°‘å› æ•°æ®è·å–å¤±è´¥å¯¼è‡´çš„é—®é¢˜

## æµ‹è¯•éªŒè¯

### é”™è¯¯å¤„ç†æµ‹è¯•

```javascript
// scripts/test-user-data.js
const errorScenarios = [
  {
    name: 'ç½‘ç»œè¿æ¥é”™è¯¯',
    error: new Error('Network connection failed'),
    shouldHandle: true,
  },
  {
    name: 'æ•°æ®åº“è¿æ¥é”™è¯¯',
    error: new Error('Database connection timeout'),
    shouldHandle: true,
  },
  {
    name: 'è®¤è¯é”™è¯¯',
    error: new Error('Authentication failed'),
    shouldHandle: true,
  },
  {
    name: 'æ­£å¸¸åº”ç”¨é”™è¯¯',
    error: new Error('Application logic error'),
    shouldHandle: false,
  },
]

// æµ‹è¯•ç»“æœï¼š
// âœ… ç½‘ç»œé”™è¯¯ï¼šğŸš« ç½‘ç»œé”™è¯¯ï¼Œä½¿ç”¨ç¼“å­˜
// âœ… æ•°æ®åº“é”™è¯¯ï¼šğŸš« ç½‘ç»œé”™è¯¯ï¼Œä½¿ç”¨ç¼“å­˜
// âœ… è®¤è¯é”™è¯¯ï¼šâš ï¸ åº”ç”¨é”™è¯¯ï¼Œéœ€è¦å¤„ç†
// âœ… åº”ç”¨é”™è¯¯ï¼šâš ï¸ åº”ç”¨é”™è¯¯ï¼Œéœ€è¦å¤„ç†
```

## æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†ç­–ç•¥

- **åˆ†ç±»å¤„ç†**ï¼šåŒºåˆ†ç½‘ç»œé”™è¯¯å’Œåº”ç”¨é”™è¯¯
- **ç¼“å­˜ä¼˜å…ˆ**ï¼šç½‘ç»œé”™è¯¯æ—¶ä¼˜å…ˆä½¿ç”¨ç¼“å­˜æ•°æ®
- **ç”¨æˆ·å‹å¥½**ï¼šé¿å…å‘ç”¨æˆ·æ˜¾ç¤ºæŠ€æœ¯æ€§é”™è¯¯

### 2. æ€§èƒ½ä¼˜åŒ–

- **å‡å°‘é‡è¯•**ï¼šé¿å…è¿‡å¤šçš„å¼‚æ­¥æ“ä½œ
- **æŒ‰éœ€è·å–**ï¼šåªåœ¨å¿…è¦æ—¶é‡æ–°è·å–æ•°æ®
- **ç¼“å­˜ç­–ç•¥**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘ç½‘ç»œè¯·æ±‚

### 3. ç›‘æ§å’Œç»´æŠ¤

- **é”™è¯¯ç›‘æ§**ï¼šç›‘æ§ç”¨æˆ·æ•°æ®è·å–çš„æˆåŠŸç‡
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§æ•°æ®è·å–çš„å“åº”æ—¶é—´
- **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·å¯¹æ•°æ®åŠ è½½ä½“éªŒçš„åé¦ˆ

## é¢„æœŸæ•ˆæœ

ä¿®å¤åçš„ç”¨æˆ·æ•°æ®è·å–åº”è¯¥ï¼š

- âœ… **ç¨³å®šè¿è¡Œ**ï¼šä¸å†å‡ºç°"ç”¨æˆ·æ•°æ®è·å–å¤±è´¥"é”™è¯¯
- âœ… **å¿«é€Ÿå“åº”**ï¼šä½¿ç”¨ç¼“å­˜æ•°æ®æä¾›å¿«é€Ÿå“åº”
- âœ… **é”™è¯¯åˆ†ç±»**ï¼šæ­£ç¡®åŒºåˆ†å’Œå¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ”¹å–„ç”¨æˆ·çš„æ•°æ®åŠ è½½ä½“éªŒ
- âœ… **å¼€å‘ä½“éªŒ**ï¼šå‡å°‘å¼€å‘è¿‡ç¨‹ä¸­çš„é”™è¯¯å¹²æ‰°

## æ•…éšœæ’é™¤

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼š

1. **æ£€æŸ¥ç½‘ç»œ**ï¼šç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
2. **æ£€æŸ¥ç¼“å­˜**ï¼šç¡®è®¤ React Query ç¼“å­˜æ­£å¸¸å·¥ä½œ
3. **æ£€æŸ¥é…ç½®**ï¼šç¡®è®¤ Supabase é…ç½®æ­£ç¡®
4. **ç›‘æ§æ—¥å¿—**ï¼šæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—äº†è§£å…·ä½“é”™è¯¯
5. **æµ‹è¯•è„šæœ¬**ï¼šè¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024 å¹´ 8 æœˆ 10 æ—¥  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**éƒ¨ç½²çŠ¶æ€**: ğŸ”„ å¾…éƒ¨ç½²  
**ç»´æŠ¤çŠ¶æ€**: ğŸ”„ æŒç»­ç›‘æ§
