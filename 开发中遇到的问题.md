# 1.RLS(Row level security),è¡Œçº§å®‰å…¨

ä¸ºæ•°æ®åº“è¡¨åˆ›å»ºè®¿é—®ç­–ç•¥ï¼ˆpolicyï¼‰ï¼Œä»¥çº¦æŸæ•°æ®çš„å¯è§æ€§.ç”¨æˆ·è®¿é—®è¯¥è¡¨æ—¶,å¦‚æœ policy ç”Ÿæ•ˆ,åˆ™ä¼šæ ¹æ® policy ä¸­å®šä¹‰çš„è¿‡æ»¤æ¡ä»¶æ¥å†³å®šç”¨æˆ·å¯æ“ä½œçš„æ•°æ®é›†åˆ.

`permission denied for schema publicï¼ˆä»£ç ï¼š42501`

1. ä¸´æ—¶åœ¨ Supabase ä¸­ç¦ç”¨ RLSï¼ˆå¿«é€Ÿè§£å†³ï¼‰
   ç‚¹å‡» "RLS" æŒ‰é’®ç¦ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
2.

```sql
-- 4. åˆ›å»ºç´¢å¼•
CREATE INDEX "PDFAnnotation_pdfUrl_idx" ON "PDFAnnotation"("pdfUrl");
CREATE INDEX "PDFAnnotation_userId_idx" ON "PDFAnnotation"("userId");
CREATE INDEX "PDFAnnotation_userId_pdfUrl_idx" ON "PDFAnnotation"("userId", "pdfUrl");

-- 6. æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON TABLE "PDFAnnotation" TO postgres;
GRANT ALL PRIVILEGES ON TABLE "PDFAnnotation" TO authenticated;
GRANT ALL PRIVILEGES ON TABLE "PDFAnnotation" TO anon;
GRANT ALL PRIVILEGES ON TABLE "PDFAnnotation" TO service_role;

-- 7. å¯ç”¨ RLS
ALTER TABLE "PDFAnnotation" ENABLE ROW LEVEL SECURITY;

-- 8. åˆ›å»ºç­–ç•¥
CREATE POLICY "ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ³¨é‡Š" ON "PDFAnnotation"
  FOR SELECT USING (auth.uid()::text = "userId");

CREATE POLICY "ç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„æ³¨é‡Š" ON "PDFAnnotation"
  FOR INSERT WITH CHECK (auth.uid()::text = "userId");

CREATE POLICY "ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„æ³¨é‡Š" ON "PDFAnnotation"
  FOR UPDATE USING (auth.uid()::text = "userId");

CREATE POLICY "ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„æ³¨é‡Š" ON "PDFAnnotation"
  FOR DELETE USING (auth.uid()::text = "userId");

-- 9.ä¸ºç”¨æˆ·è§’è‰²æˆæƒ public schema æƒé™ã€‚
-- ä¹‹å‰ï¼šç”¨æˆ·æœ‰æ•°æ®åº“ CREATE æƒé™å°±èƒ½åœ¨ public schema ä¸­åˆ›å»ºè¡¨
-- ç°åœ¨ï¼šéœ€è¦æ˜ç¡®æˆæƒç”¨æˆ·å¯¹ public schema çš„æƒé™

-- ä¸º authenticated è§’è‰²æˆæƒ public schema æƒé™
GRANT ALL ON SCHEMA public TO authenticated;

-- ä¸º anon è§’è‰²æˆæƒ public schema æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
GRANT ALL ON SCHEMA public TO anon;

-- ä¸º service_role è§’è‰²æˆæƒ public schema æƒé™
GRANT ALL ON SCHEMA public TO service_role;

-- ç¡®ä¿æ‰€æœ‰è¡¨éƒ½æœ‰æ­£ç¡®çš„æƒé™
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO anon;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO service_role;

-- ä¸ºå°†æ¥åˆ›å»ºçš„è¡¨è®¾ç½®é»˜è®¤æƒé™
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO authenticated;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO anon;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO service_role;
```

# 2.å˜æ›´è¡¨ç»“æ„åŒæ­¥åˆ° Supabase

åœ¨å¼€å‘é˜¶æ®µå°† Prisma Schema æ›´æ–°åŒæ­¥åˆ° Supabase çš„æ­¥éª¤ï¼š

### 1. ç”Ÿæˆè¿ç§» SQL

é¦–å…ˆï¼Œä½¿ç”¨ Prisma ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼š

```bash
npx prisma migrate dev --name update_user_profile_schema
```

è¿™ä¼šåœ¨ `prisma/migrations` ç›®å½•ä¸‹ç”ŸæˆåŒ…å« SQL è¯­å¥çš„è¿ç§»æ–‡ä»¶ã€‚

### 2. å°†è¿ç§»åº”ç”¨åˆ° Supabase

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Supabase SQL ç¼–è¾‘å™¨

1. ç™»å½• [Supabase æ§åˆ¶å°](https://app.supabase.com)
2. é€‰æ‹©æ‚¨çš„é¡¹ç›®
3. è¿›å…¥ "SQL ç¼–è¾‘å™¨" æ ‡ç­¾
4. åˆ›å»ºæ–°æŸ¥è¯¢
5. å¤åˆ¶ Prisma è¿ç§»æ–‡ä»¶ä¸­çš„ SQL è¯­å¥
6. åœ¨ SQL ç¼–è¾‘å™¨ä¸­ç²˜è´´å¹¶æ‰§è¡Œè¿™äº›è¯­å¥

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ Prisma ç›´æ¥è¿æ¥ Supabaseï¼ˆå¦‚æœé…ç½®äº†ç›´æ¥è¿æ¥ï¼‰

å¦‚æœæ‚¨å·²ç»é…ç½®äº† Prisma ç›´æ¥è¿æ¥ Supabase æ•°æ®åº“ï¼Œå¯ä»¥æ‰§è¡Œï¼š

```bash
DATABASE_URL=your_supabase_connection_string npx prisma migrate deploy
```

### 3. æ›´æ–°æœ¬åœ° Prisma å®¢æˆ·ç«¯

åº”ç”¨è¿ç§»åï¼Œæ›´æ–° Prisma å®¢æˆ·ç«¯ï¼š

```bash
npx prisma generate
```

### 4. éªŒè¯æ›´æ”¹

åœ¨ Supabase æ§åˆ¶å°ä¸­ï¼Œè¿›å…¥ "è¡¨ç¼–è¾‘å™¨" ç¡®è®¤ `UserProfile` è¡¨ç»“æ„æ˜¯å¦å·²æ­£ç¡®æ›´æ–°ï¼š

- æ£€æŸ¥æ˜¯å¦æ·»åŠ äº† `date` å­—æ®µ
- ç¡®è®¤ `school` å­—æ®µæ˜¯å¦å·²è¢«ç§»é™¤æˆ–é‡å‘½å
- éªŒè¯å…¶ä»–æ›´æ”¹æ˜¯å¦æ­£ç¡®åº”ç”¨

### æç¤ºä¸æŠ€å·§

1. **å¼€å‘ä¸­é¢‘ç¹æ›´æ–°**ï¼šåœ¨å¼€å‘é˜¶æ®µé¢‘ç¹æ›´æ”¹ schema æ—¶ï¼Œå¯ä»¥è€ƒè™‘ï¼š

   ```bash
   npx prisma db push
   ```

   è¿™ä¼šç›´æ¥å°† schema å˜æ›´æ¨é€åˆ°æ•°æ®åº“ï¼Œä½†ä¸ä¼šç”Ÿæˆè¿ç§»å†å²

2. **å¯¼å…¥ä¸å¯¼å‡ºæ•°æ®**ï¼šå¦‚æœéœ€è¦ä¿ç•™æ•°æ®ï¼Œå¯ä»¥å…ˆåœ¨ Supabase ä¸­å¯¼å‡ºæ•°æ®ï¼Œåº”ç”¨è¿ç§»åå†å¯¼å…¥

3. **é‡ç½®å¼€å‘ç¯å¢ƒ**ï¼šå¦‚æœåªæ˜¯å¼€å‘ç¯å¢ƒä¸”æ•°æ®ä¸é‡è¦ï¼Œå¯ä»¥è€ƒè™‘å®Œå…¨é‡ç½®æ•°æ®åº“ï¼š
   ```sql
   -- åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­æ‰§è¡Œ
   DROP SCHEMA public CASCADE;
   CREATE SCHEMA public;
   GRANT ALL ON SCHEMA public TO postgres;
   GRANT ALL ON SCHEMA public TO public;
   ```
   ç„¶åé‡æ–°åº”ç”¨å…¨éƒ¨è¿ç§»

# 3.æ°´å’Œä¸åŒ¹é…é—®é¢˜

1. **å®Œå…¨å®¢æˆ·ç«¯æ¸²æŸ“**ï¼šé€šè¿‡ä½¿ç”¨`mounted`çŠ¶æ€å’Œ`useEffect`ï¼Œç¡®ä¿ Toaster å’Œ TopLoader ç»„ä»¶åªåœ¨å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œé¿å…äº†æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„å·®å¼‚

2. **æ¡ä»¶æ¸²æŸ“**ï¼šæœåŠ¡å™¨æ¸²æŸ“æ—¶è¿”å›`null`ï¼Œå®¢æˆ·ç«¯æŒ‚è½½åæ‰æ¸²æŸ“å®é™…ç»„ä»¶

3. **æ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸ**ï¼šä½¿ç”¨`useEffect`æ¸…æ™°åœ°æ§åˆ¶ç»„ä»¶çš„æŒ‚è½½/å¸è½½è¡Œä¸º

é€šè¿‡è¿™äº›æ”¹è¿›ï¼Œç°åœ¨ä¸åº”è¯¥å†å‡ºç°æ°´åˆä¸åŒ¹é…é”™è¯¯ã€‚è¿™ç§æ–¹æ³•æ˜¯å¤„ç†é‚£äº›åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ¸²æŸ“ç»“æœä¸åŒçš„ç»„ä»¶çš„æœ€å¯é æ–¹å¼ã€‚

4. ç»„ä»¶æ¸²æŸ“çš„ä¸‰ä¸ªé˜¶æ®µ
   - æœåŠ¡å™¨æ¸²æŸ“ï¼šè¿”å› nullï¼ˆä¸æ¸²æŸ“ä»»ä½•å†…å®¹ï¼‰
   - å®¢æˆ·ç«¯åˆå§‹æ¸²æŸ“ï¼ˆæ°´åˆï¼‰ï¼šè¿”å› nullï¼ˆä¸æœåŠ¡å™¨æ¸²æŸ“ç»“æœåŒ¹é…ï¼‰
   - å®¢æˆ·ç«¯ useEffect æ‰§è¡Œåï¼šmounted=trueï¼Œæ¸²æŸ“å®é™…ç»„ä»¶
   - è¿™ç§æ¨¡å¼ç‰¹åˆ«é€‚åˆå¤„ç†é‚£äº›ä¾èµ–äºæµè§ˆå™¨ç¯å¢ƒã€éšæœºæ€§ã€æˆ–ä¼šäº§ç”Ÿä¸ä¸€è‡´æ¸²æŸ“ç»“æœçš„ç»„ä»¶ï¼Œæ¯”å¦‚ toast é€šçŸ¥ã€è¿›åº¦æ¡ç­‰ UI å…ƒç´ ã€‚
   - ç®€è€Œè¨€ä¹‹ï¼Œè¿™æ˜¯ä¸€ç§"å»¶è¿Ÿå®¢æˆ·ç«¯æ¸²æŸ“"çš„æŠ€æœ¯ï¼Œå…ˆç¡®ä¿æ°´åˆæˆåŠŸï¼Œç„¶åå†åœ¨çº¯å®¢æˆ·ç«¯ç¯å¢ƒä¸­æ¸²æŸ“å®é™…å†…å®¹ã€‚

# 4.ä»€ä¹ˆæ—¶å€™ç”¨ Server Action?ä»€ä¹ˆæ—¶å€™ç”¨ API è·¯ç”±?

## 1. Server Actionï¼ˆæœåŠ¡å™¨åŠ¨ä½œï¼‰

- **æœ¬è´¨**ï¼šç›´æ¥åœ¨æœåŠ¡ç«¯è¿è¡Œçš„å‡½æ•°ï¼Œå¯ä»¥åœ¨ç»„ä»¶/é¡µé¢ä¸­ç›´æ¥è°ƒç”¨ï¼ˆå¦‚ `await updateUser(data)`ï¼‰ã€‚
- **è°ƒç”¨æ–¹å¼**ï¼šåªèƒ½åœ¨æœåŠ¡ç«¯ï¼ˆå¦‚ React Server Componentã€`app` ç›®å½•çš„ `server` ç»„ä»¶ã€æˆ– `use server` çš„ actionï¼‰ç›´æ¥è°ƒç”¨ï¼Œä¸èƒ½è¢«æµè§ˆå™¨ç›´æ¥è¯·æ±‚ã€‚
- **ä¼˜ç‚¹**ï¼š
  - ç±»å‹å®‰å…¨ï¼Œå‚æ•°å’Œè¿”å›å€¼éƒ½åœ¨åŒä¸€ä¸ª TypeScript é¡¹ç›®é‡Œã€‚
  - æ— éœ€æ‰‹åŠ¨å†™ API è·¯ç”±ï¼Œç›´æ¥ import è°ƒç”¨ã€‚
  - é€‚åˆè¡¨å•æäº¤ã€æ•°æ®å¤„ç†ã€æ•°æ®åº“æ“ä½œç­‰ã€‚
- **ç¼ºç‚¹**ï¼š
  - åªèƒ½åœ¨ Next.js çš„æœåŠ¡ç«¯ç¯å¢ƒä¸‹ç”¨ï¼Œä¸èƒ½è¢«å¤–éƒ¨ç³»ç»Ÿæˆ– Postman ç›´æ¥è®¿é—®ã€‚
  - ä¸èƒ½å¤„ç† multipart/form-dataï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ï¼‰ç­‰ç‰¹æ®Šè¯·æ±‚ï¼ˆç›®å‰ï¼‰ã€‚

**ä½ çš„ `actions/updateUser.ts` å°±æ˜¯ä¸€ä¸ª Server Actionï¼š**

```ts
// åªèƒ½åœ¨æœåŠ¡ç«¯ç›´æ¥ import å¹¶è°ƒç”¨
import { updateUser } from '@/actions/updateUser'
await updateUser(data)
```

---

## 2. API è·¯ç”±ï¼ˆAPI Routeï¼‰

- **æœ¬è´¨**ï¼šä¸€ä¸ª HTTP æ¥å£ï¼ˆå¦‚ `/api/xxx`ï¼‰ï¼Œå¯ä»¥è¢«å‰ç«¯ fetchã€axiosã€å¤–éƒ¨ç³»ç»Ÿã€Postman ç­‰ç›´æ¥è¯·æ±‚ã€‚
- **è°ƒç”¨æ–¹å¼**ï¼šé€šè¿‡ HTTP è¯·æ±‚ï¼ˆGET/POST/PUT/DELETEï¼‰ï¼Œå‰ç«¯ç”¨ `fetch('/api/xxx')` è°ƒç”¨ã€‚
- **ä¼˜ç‚¹**ï¼š
  - çµæ´»ï¼Œæ”¯æŒå„ç§ HTTP è¯·æ±‚å’Œå†…å®¹ç±»å‹ï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ï¼‰ã€‚
  - å¯è¢«ä»»ä½•å®¢æˆ·ç«¯æˆ–ç¬¬ä¸‰æ–¹ç³»ç»Ÿè®¿é—®ã€‚
- **ç¼ºç‚¹**ï¼š
  - éœ€è¦æ‰‹åŠ¨å¤„ç†è¯·æ±‚ä½“ã€å‚æ•°æ ¡éªŒã€è¿”å›æ ¼å¼ç­‰ã€‚
  - ç±»å‹å®‰å…¨æ€§ä¸å¦‚ Server Actionã€‚

**API è·¯ç”±ä¾‹å­ï¼š**

```ts
// app/api/update-user/route.ts
export async function POST(req: Request) {
  const data = await req.json()
  // ...å¤„ç†é€»è¾‘
  return Response.json({ success: true })
}
```

### 2.1. `app/api/pdf2md/route.ts`ï¼ˆApp Router æ–°å†™æ³•ï¼‰

- **å±äº Next.js 13+ çš„ App Routerï¼ˆapp ç›®å½•ï¼‰ä½“ç³»ã€‚**
- æ–‡ä»¶è·¯å¾„ï¼š`app/api/pdf2md/route.ts`
- **å¯¼å‡ºæ–¹å¼**ï¼šå¯¼å‡º `GET`ã€`POST` ç­‰å‡½æ•°ï¼ˆå¦‚ `export async function POST()`ï¼‰ã€‚
- **æ”¯æŒç‰¹æ€§**ï¼š
  - æ”¯æŒ Edge/Server è¿è¡Œæ—¶ï¼ˆå¯é€‰ï¼‰ã€‚
  - æ”¯æŒä¸­é—´ä»¶ã€æµå¼å“åº”ç­‰æ–°ç‰¹æ€§ã€‚
  - æ¨èç”¨äºæ–°é¡¹ç›®å’Œæœªæ¥ç»´æŠ¤ã€‚
- **è°ƒç”¨æ–¹å¼**ï¼šå‰ç«¯ `fetch('/api/pdf2md', { method: 'POST', ... })`ã€‚

**ç¤ºä¾‹ï¼š**

```ts
// app/api/pdf2md/route.ts
export async function POST(req: Request) {
  // å¤„ç†é€»è¾‘
  return Response.json({ markdown: '...' })
}
```

---

### 2.2 `pages/api/pdf2md.ts`ï¼ˆPages Router ä¼ ç»Ÿå†™æ³•ï¼‰

- **å±äº Next.js 12 åŠä»¥å‰çš„ Pages Routerï¼ˆpages ç›®å½•ï¼‰ä½“ç³»ã€‚**
- æ–‡ä»¶è·¯å¾„ï¼š`pages/api/pdf2md.ts`
- **å¯¼å‡ºæ–¹å¼**ï¼šå¯¼å‡ºä¸€ä¸ªé»˜è®¤çš„ handler å‡½æ•°ï¼ˆ`(req, res) => {}`ï¼‰ã€‚
- **æ”¯æŒç‰¹æ€§**ï¼š
  - å…¼å®¹è€é¡¹ç›®ï¼Œå†™æ³•å’Œ Express ç±»ä¼¼ã€‚
  - ä¸æ”¯æŒ Edge Runtimeã€æµå¼å“åº”ç­‰æ–°ç‰¹æ€§ã€‚
  - æœªæ¥ Next.js å®˜æ–¹æ¨èé€æ­¥è¿ç§»åˆ° app ç›®å½•ã€‚
- **è°ƒç”¨æ–¹å¼**ï¼šå‰ç«¯ `fetch('/api/pdf2md', { method: 'POST', ... })`ã€‚

**ç¤ºä¾‹ï¼š**

```ts
// pages/api/pdf2md.ts
export default async function handler(req, res) {
  // å¤„ç†é€»è¾‘
  res.status(200).json({ markdown: '...' })
}
```

---

## 3. æ€»ç»“å¯¹æ¯”è¡¨

| ç‰¹æ€§/åŒºåˆ«        |   `app/api/pdf2md/route.ts`    |    `pages/api/pdf2md.ts`    |
| ---------------- | :----------------------------: | :-------------------------: |
| æ‰€å±ä½“ç³»         |     App Routerï¼ˆæ–°ï¼Œæ¨èï¼‰     |  Pages Routerï¼ˆè€ï¼Œå…¼å®¹ï¼‰   |
| Next.js ç‰ˆæœ¬     |        13+ï¼ˆapp ç›®å½•ï¼‰         |   12 åŠä»¥å‰ï¼ˆpages ç›®å½•ï¼‰   |
| å¯¼å‡ºæ–¹å¼         | `export async function POST()` | `export default function()` |
| Edge/Server æ”¯æŒ |    æ”¯æŒ Edge/Server è¿è¡Œæ—¶     |      ä»… Node.js è¿è¡Œæ—¶      |
| æ–°ç‰¹æ€§           |     æ”¯æŒæµå¼å“åº”ã€ä¸­é—´ä»¶ç­‰     |           ä¸æ”¯æŒ            |
| å®˜æ–¹æ¨è         |      æ–°é¡¹ç›®/æœªæ¥ç»´æŠ¤ä¼˜å…ˆ       |        æ—§é¡¹ç›®/å…¼å®¹æ€§        |

## 3. ä»€ä¹ˆæ—¶å€™ç”¨ Server Actionï¼Œä»€ä¹ˆæ—¶å€™ç”¨ API è·¯ç”±ï¼Ÿ

- **è¡¨å•ã€æŒ‰é’®ã€æ•°æ®æ›´æ–°**ï¼ˆåªåœ¨ Next.js å†…éƒ¨ç”¨ï¼‰ï¼šä¼˜å…ˆç”¨ Server Actionï¼Œä»£ç æ›´ç®€æ´ã€ç±»å‹å®‰å…¨ã€‚
- **éœ€è¦è¢«å¤–éƒ¨ç³»ç»Ÿ/ç¬¬ä¸‰æ–¹/å‰ç«¯ fetch è°ƒç”¨**ï¼šç”¨ API è·¯ç”±ã€‚
- **æ–‡ä»¶ä¸Šä¼ ã€ç‰¹æ®Šè¯·æ±‚ä½“**ï¼šç›®å‰åªèƒ½ç”¨ API è·¯ç”±ã€‚

---

## 4. ä½ çš„é¡¹ç›®ä¸¾ä¾‹

- `actions/updateUser.ts` é€‚åˆåœ¨ Next.js å†…éƒ¨ç›´æ¥è°ƒç”¨ï¼ˆå¦‚è¡¨å•æäº¤ï¼‰ã€‚
- å¦‚æœä½ è¦åšâ€œPDF è½¬ Markdownâ€ï¼Œ**å¿…é¡»ç”¨ API è·¯ç”±**ï¼Œå› ä¸ºè¦å¤„ç† multipart/form-data æ–‡ä»¶ä¸Šä¼ ï¼ŒServer Action æš‚ä¸æ”¯æŒã€‚

---

## æ€»ç»“

| åœºæ™¯          | Server Actionï¼ˆactions/xxx.tsï¼‰ | API è·¯ç”±ï¼ˆapi/xxx/route.tsï¼‰ |
| ------------- | :-----------------------------: | :--------------------------: |
| å†…éƒ¨è¡¨å•/æŒ‰é’® |            æ¨èä½¿ç”¨             |             å¯ç”¨             |
| å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨  |              ä¸è¡Œ               |             æ¨è             |
| æ–‡ä»¶ä¸Šä¼       |              ä¸è¡Œ               |             æ¨è             |
| ç±»å‹å®‰å…¨      |             éå¸¸å¥½              |          éœ€æ‰‹åŠ¨æ ¡éªŒ          |

---

å¦‚éœ€å…·ä½“ä»£ç ç¤ºä¾‹æˆ–é›†æˆå»ºè®®ï¼Œè¯·éšæ—¶å‘ŠçŸ¥ï¼

# 5.é€šè¿‡ SQL åˆ›å»ºè¡¨å¯èƒ½å¯¼è‡´æƒé™é—®é¢˜

```SQL
-- åˆ›å»ºè¡¨åï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹SQLæ£€æŸ¥æƒé™ï¼š
SELECT
    grantee,
    table_name,
    privilege_type
FROM information_schema.table_privileges
WHERE table_name = 'your_table_name'
ORDER BY grantee, privilege_type;

-- å¦‚æœæ²¡æœ‰æƒé™

-- 1. æˆäºˆæ‰€æœ‰æƒé™ç»™ postgres ç”¨æˆ·ï¼ˆè¡¨æ‰€æœ‰è€…ï¼‰
GRANT ALL PRIVILEGES ON TABLE "PDFAnnotation" TO postgres;

-- 2. æˆäºˆæ‰€æœ‰æƒé™ç»™ authenticated è§’è‰²ï¼ˆè®¤è¯ç”¨æˆ·ï¼‰
GRANT ALL PRIVILEGES ON TABLE "PDFAnnotation" TO authenticated;

-- 3. æˆäºˆæ‰€æœ‰æƒé™ç»™ anon è§’è‰²ï¼ˆåŒ¿åç”¨æˆ·ï¼‰
GRANT ALL PRIVILEGES ON TABLE "PDFAnnotation" TO anon;

-- 4. æˆäºˆæ‰€æœ‰æƒé™ç»™ service_role è§’è‰²ï¼ˆæœåŠ¡è§’è‰²ï¼‰
GRANT ALL PRIVILEGES ON TABLE "PDFAnnotation" TO service_role;

```

## 5.1 é¢„é˜²æªæ–½

### 5.1.1 ä½¿ç”¨ Supabase Dashboard åˆ›å»ºè¡¨

- é€šè¿‡ Dashboard åˆ›å»ºè¡¨ä¼šè‡ªåŠ¨é…ç½®æ­£ç¡®çš„æƒé™,é¿å…ç›´æ¥ä½¿ç”¨ SQL åˆ›å»ºè¡¨

# Supabase å®¢æˆ·ç«¯å’Œ Prisma å®¢æˆ·ç«¯åŒºåˆ«

### ï¿½ï¿½ **å®é™…æƒ…å†µåˆ†æ**

#### 1. **Prisma å®¢æˆ·ç«¯**

- **ä¸æ˜¯** å¤„ç†æœ¬åœ°æ•°æ®åº“
- **è€Œæ˜¯** å¤„ç† **çº¿ä¸Š Supabase PostgreSQL æ•°æ®åº“**
- ä» `prisma/schema.prisma` å¯ä»¥çœ‹åˆ°ï¼š
  ```prisma
  datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")      // è¿æ¥çº¿ä¸Šæ•°æ®åº“
    directUrl = env("DIRECT_URL")        // ç›´æ¥è¿æ¥çº¿ä¸Šæ•°æ®åº“
    schemas   = ["public"]
  }
  ```

#### 2. **Supabase å®¢æˆ·ç«¯**

- **ä¸æ˜¯** åªå¤„ç†æƒé™æ ¡éªŒ
- **è€Œæ˜¯** æä¾›å®Œæ•´çš„æ•°æ®åº“æ“ä½œåŠŸèƒ½
- åŒ…æ‹¬ï¼šè®¤è¯ã€æƒé™ã€å®æ—¶è®¢é˜…ã€æ•°æ®åº“æ“ä½œç­‰

## ğŸ“Š **å®ƒä»¬çš„å…³ç³»å’ŒåŒºåˆ«**

### **ç›¸åŒç‚¹ï¼š**

- éƒ½è¿æ¥ **åŒä¸€ä¸ªçº¿ä¸Š Supabase PostgreSQL æ•°æ®åº“**
- éƒ½å¯ä»¥è¿›è¡Œæ•°æ®åº“æ“ä½œ

### **ä¸åŒç‚¹ï¼š**

| ç‰¹æ€§         | Prisma å®¢æˆ·ç«¯         | Supabase å®¢æˆ·ç«¯   |
| ------------ | --------------------- | ----------------- |
| **ç±»å‹å®‰å…¨** | âœ… å®Œå…¨ç±»å‹å®‰å…¨       | âŒ éœ€è¦æ‰‹åŠ¨å¤„ç†   |
| **æŸ¥è¯¢è¯­è¨€** | Prisma Query Language | SQL + æŸ¥è¯¢æ„å»ºå™¨  |
| **è‡ªåŠ¨åŠŸèƒ½** | è‡ªåŠ¨ç”Ÿæˆ IDã€é»˜è®¤å€¼   | éœ€è¦æ‰‹åŠ¨å¤„ç†      |
| **è®¤è¯**     | âŒ ä¸å¤„ç†è®¤è¯         | âœ… å®Œæ•´çš„è®¤è¯ç³»ç»Ÿ |
| **å®æ—¶åŠŸèƒ½** | âŒ ä¸æ”¯æŒ             | âœ… å®æ—¶è®¢é˜…       |
| **æƒé™æ§åˆ¶** | âŒ ä¸å¤„ç†             | âœ… RLS ç­–ç•¥       |

## ğŸ”„ **æ•°æ®æµå‘**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç»„ä»¶      â”‚    â”‚   Prisma å®¢æˆ·ç«¯  â”‚    â”‚  Supabase æ•°æ®åº“ â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ - ç±»å‹å®‰å…¨      â”‚â”€â”€â”€â–¶â”‚ - è‡ªåŠ¨ç”Ÿæˆ ID   â”‚â”€â”€â”€â–¶â”‚ - PostgreSQL    â”‚
â”‚ - è‡ªåŠ¨éªŒè¯      â”‚    â”‚ - é»˜è®¤å€¼å¤„ç†    â”‚    â”‚ - è¡¨ç»“æ„        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â–²
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   Supabase å®¢æˆ·ç«¯â”‚    â”‚   è®¤è¯ & æƒé™    â”‚              â”‚
â”‚                â”‚    â”‚                â”‚              â”‚
â”‚ - è®¤è¯ç®¡ç†      â”‚    â”‚ - ç”¨æˆ·ä¼šè¯      â”‚              â”‚
â”‚ - å®æ—¶è®¢é˜…      â”‚    â”‚ - RLS ç­–ç•¥      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ - æƒé™æ§åˆ¶      â”‚    â”‚ - æœåŠ¡è§’è‰²      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ï¿½ï¿½ **æœ€ä½³å®è·µå»ºè®®**

### **æ··åˆä½¿ç”¨æ¨¡å¼ï¼š**

```typescript
// 1. ä½¿ç”¨ Supabase è¿›è¡Œè®¤è¯
const supabase = await createAdminClient()
const {
  data: { user },
} = await supabase.auth.getUser()

// 2. ä½¿ç”¨ Prisma è¿›è¡Œæ•°æ®åº“æ“ä½œ
const data = await prisma.category.create({
  data: {
    name: 'æŠ€æœ¯',
    description: 'æŠ€æœ¯ç›¸å…³æ–‡ç« ',
  },
})
```

### **æ¨èä½¿ç”¨åœºæ™¯ï¼š**

#### **ä½¿ç”¨ Prisma å®¢æˆ·ç«¯ï¼š**

- âœ… æ•°æ®åº“ CRUD æ“ä½œ
- âœ… å¤æ‚æŸ¥è¯¢å’Œå…³ç³»
- âœ… éœ€è¦ç±»å‹å®‰å…¨çš„åœ°æ–¹
- âœ… æ‰¹é‡æ“ä½œ

#### **ä½¿ç”¨ Supabase å®¢æˆ·ç«¯ï¼š**

- âœ… ç”¨æˆ·è®¤è¯å’Œæˆæƒ
- âœ… å®æ—¶æ•°æ®è®¢é˜…
- âœ… æ–‡ä»¶ä¸Šä¼ 
- âœ… éœ€è¦ RLS ç­–ç•¥çš„åœ°æ–¹

## ğŸ¯ **æ€»ç»“**

1. **Prisma** å’Œ **Supabase** éƒ½è¿æ¥åŒä¸€ä¸ªçº¿ä¸Šæ•°æ®åº“
2. **Prisma** æä¾›ç±»å‹å®‰å…¨å’Œè‡ªåŠ¨åŠŸèƒ½
3. **Supabase** æä¾›è®¤è¯ã€æƒé™å’Œå®æ—¶åŠŸèƒ½
4. **å»ºè®®æ··åˆä½¿ç”¨**ï¼šè®¤è¯ç”¨ Supabaseï¼Œæ•°æ®æ“ä½œç”¨ Prisma
5. **æ²¡æœ‰æœ¬åœ°æ•°æ®åº“**ï¼Œéƒ½æ˜¯æ“ä½œçº¿ä¸Š Supabase æ•°æ®åº“

æ‚¨è¯´å¾—å¯¹ï¼Œç¡®å®æœ‰ç‚¹å¤æ‚ï¼è®©æˆ‘ç»™æ‚¨ä¸€ä¸ªç®€å•çš„åˆ¤æ–­æ ‡å‡†ï¼š

## ï¿½ï¿½ **ç®€å•åˆ¤æ–­æ ‡å‡†**

### **ä½¿ç”¨ Supabase å®¢æˆ·ç«¯ï¼š**

1. **éœ€è¦ç”¨æˆ·ç™»å½•éªŒè¯**
2. **éœ€è¦æ£€æŸ¥ç”¨æˆ·æƒé™**
3. **éœ€è¦å®æ—¶åŠŸèƒ½ï¼ˆå¦‚èŠå¤©ï¼‰**
4. **éœ€è¦æ–‡ä»¶ä¸Šä¼ **

### **ä½¿ç”¨ Prisma å®¢æˆ·ç«¯ï¼š**

1. **çº¯æ•°æ®åº“æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰**
2. **ä¸éœ€è¦ç”¨æˆ·éªŒè¯çš„å…¬å¼€æ•°æ®**
3. **å¤æ‚çš„æ•°æ®åº“æŸ¥è¯¢**

## ğŸ“‹ **å…·ä½“åœºæ™¯å¯¹ç…§è¡¨**

| åœºæ™¯             | ä½¿ç”¨å“ªä¸ª | åŸå›                   |
| ---------------- | -------- | --------------------- |
| ç”¨æˆ·ç™»å½•/æ³¨å†Œ    | Supabase | éœ€è¦è®¤è¯              |
| æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½• | Supabase | éœ€è¦è®¤è¯              |
| åˆ›å»ºåšå®¢æ–‡ç«      | **æ··åˆ** | éœ€è¦è®¤è¯ + æ•°æ®åº“æ“ä½œ |
| æŸ¥çœ‹åšå®¢åˆ—è¡¨     | Prisma   | çº¯æ•°æ®åº“æŸ¥è¯¢          |
| åˆ é™¤æ–‡ç«          | **æ··åˆ** | éœ€è¦è®¤è¯ + æ•°æ®åº“æ“ä½œ |
| ä¸Šä¼ æ–‡ä»¶         | Supabase | æ–‡ä»¶å­˜å‚¨åŠŸèƒ½          |
| å®æ—¶èŠå¤©         | Supabase | å®æ—¶åŠŸèƒ½              |

## ï¿½ï¿½ **ç®€åŒ–æ–¹æ¡ˆ**

### **æ–¹æ¡ˆä¸€ï¼šå…¨éƒ¨ç”¨ Prismaï¼ˆæœ€ç®€å•ï¼‰**

```typescript
// æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½ç”¨ Prisma
export async function createCategory(formData: TCategorySchema) {
  try {
    // ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œä¸åšæƒé™æ£€æŸ¥
    const data = await prisma.category.create({
      data: {
        name: formData.name,
        description: formData.description,
      },
    })
    return { success: true, data }
  } catch (error) {
    return { success: false, error: error.message }
  }
}
```

**ä¼˜ç‚¹ï¼š** ç®€å•ï¼Œä»£ç å°‘
**ç¼ºç‚¹ï¼š** æ²¡æœ‰æƒé™æ§åˆ¶ï¼Œä¸å®‰å…¨

### **æ–¹æ¡ˆäºŒï¼šå…¨éƒ¨ç”¨ Supabaseï¼ˆä¿æŒç°çŠ¶ï¼‰**

```typescript
// ç»§ç»­ä½¿ç”¨ç°æœ‰çš„ Supabase æ–¹å¼
export async function createCategory(formData: TCategorySchema) {
  try {
    const supabase = await createAdminClient()
    const { data, error } = await supabase
      .from('Category')
      .insert({
        id: crypto.randomUUID(), // æ‰‹åŠ¨ç”Ÿæˆ ID
        name: formData.name,
        description: formData.description,
      })
      .select()
      .single()

    return { success: true, data }
  } catch (error) {
    return { success: false, error: error.message }
  }
}
```

**ä¼˜ç‚¹ï¼š** ä¿æŒç°æœ‰ä»£ç ä¸å˜
**ç¼ºç‚¹ï¼š** éœ€è¦æ‰‹åŠ¨å¤„ç† ID ç”Ÿæˆ

### **æ–¹æ¡ˆä¸‰ï¼šæ··åˆä½¿ç”¨ï¼ˆæ¨èï¼‰**

```typescript
// è®¤è¯ç”¨ Supabaseï¼Œæ•°æ®æ“ä½œç”¨ Prisma
export async function createCategory(formData: TCategorySchema) {
  try {
    // 1. è®¤è¯æ£€æŸ¥
    const supabase = await createAdminClient()
    const {
      data: { user },
    } = await supabase.auth.getUser()
    if (!user) throw new Error('è¯·å…ˆç™»å½•')

    // 2. æ•°æ®æ“ä½œ
    const data = await prisma.category.create({
      data: {
        name: formData.name,
        description: formData.description,
      },
    })

    return { success: true, data }
  } catch (error) {
    return { success: false, error: error.message }
  }
}
```

## ğŸ¯ **æˆ‘çš„å»ºè®®**

### **å¦‚æœæ‚¨æƒ³è¦ç®€å•ï¼š**

é€‰æ‹© **æ–¹æ¡ˆäºŒï¼ˆå…¨éƒ¨ç”¨ Supabaseï¼‰**ï¼Œåªéœ€è¦ä¿®å¤ ID ç”Ÿæˆé—®é¢˜ï¼š

```typescript
// åœ¨æ’å…¥æ—¶æ‰‹åŠ¨ç”Ÿæˆ ID
.insert({
  id: crypto.randomUUID(), // æ·»åŠ è¿™è¡Œ
  name: validatedData.name,
  description: validatedData.description,
})
```

### **å¦‚æœæ‚¨æƒ³è¦æ›´å¥½çš„å¼€å‘ä½“éªŒï¼š**

é€‰æ‹© **æ–¹æ¡ˆä¸‰ï¼ˆæ··åˆä½¿ç”¨ï¼‰**ï¼Œä½†åªåœ¨å…³é”®åœ°æ–¹ä½¿ç”¨ï¼š

```typescript
// åªåœ¨éœ€è¦æƒé™çš„åœ°æ–¹æ··åˆä½¿ç”¨
// å…¶ä»–åœ°æ–¹éƒ½ç”¨ Prisma
```

## ï¿½ï¿½ **å¿«é€Ÿå†³ç­–æŒ‡å—**

**é—®è‡ªå·±ï¼šè¿™ä¸ªæ“ä½œéœ€è¦ç”¨æˆ·ç™»å½•å—ï¼Ÿ**

- **éœ€è¦ç™»å½•** â†’ ç”¨ Supabase æˆ–æ··åˆä½¿ç”¨
- **ä¸éœ€è¦ç™»å½•** â†’ ç”¨ Prisma

**é—®è‡ªå·±ï¼šè¿™ä¸ªæ“ä½œæ¶‰åŠæ–‡ä»¶ä¸Šä¼ å—ï¼Ÿ**

- **æ¶‰åŠæ–‡ä»¶** â†’ ç”¨ Supabase
- **ä¸æ¶‰åŠæ–‡ä»¶** â†’ ç”¨ Prisma

**é—®è‡ªå·±ï¼šè¿™ä¸ªæ“ä½œéœ€è¦å®æ—¶æ›´æ–°å—ï¼Ÿ**

- **éœ€è¦å®æ—¶** â†’ ç”¨ Supabase
- **ä¸éœ€è¦å®æ—¶** â†’ ç”¨ Prisma

è¿™æ ·åˆ¤æ–­å°±ç®€å•å¤šäº†ï¼æ‚¨è§‰å¾—å“ªç§æ–¹æ¡ˆé€‚åˆæ‚¨ï¼Ÿ

## ï¿½ï¿½ **Supabase èƒ½å¦æ›¿ä»£ Prismaï¼Ÿ**

### **âœ… Supabase å¯ä»¥å®ç°çš„ï¼š**

1. **æ•°æ®åº“ CRUD æ“ä½œ** âœ…
2. **å¤æ‚æŸ¥è¯¢** âœ…
3. **å…³ç³»æŸ¥è¯¢** âœ…
4. **ç±»å‹å®‰å…¨** âœ… (é€šè¿‡ TypeScript)
5. **è‡ªåŠ¨ç”Ÿæˆ ID** âœ… (é€šè¿‡æ•°æ®åº“é…ç½®)
6. **æƒé™æ§åˆ¶** âœ… (RLS ç­–ç•¥)
7. **å®æ—¶åŠŸèƒ½** âœ…
8. **æ–‡ä»¶å­˜å‚¨** âœ…

### **âŒ Supabase çš„å±€é™æ€§ï¼š**

1. **ç±»å‹å®‰å…¨ä¸å¦‚ Prisma** (éœ€è¦æ‰‹åŠ¨å®šä¹‰ç±»å‹)
2. **æŸ¥è¯¢è¯­æ³•ç›¸å¯¹å¤æ‚**
3. **æ²¡æœ‰è‡ªåŠ¨çš„å­—æ®µæ˜ å°„**
4. **éœ€è¦æ‰‹åŠ¨å¤„ç†é»˜è®¤å€¼**

## ğŸ¯ **æ¨èæ–¹æ¡ˆï¼šçº¯ Supabase**

### **ä¼˜ç‚¹ï¼š**

1. **åªéœ€è¦å­¦ä¸€å¥—è¯­æ³•**
2. **åŠŸèƒ½å®Œæ•´** (è®¤è¯ã€æ•°æ®åº“ã€å®æ—¶ã€æ–‡ä»¶)
3. **éƒ¨ç½²ç®€å•** (ä¸€ä¸ªå¹³å°æå®š)
4. **æˆæœ¬ä½** (å…è´¹é¢åº¦å¤§)

### **ç¼ºç‚¹ï¼š**

1. **ç±»å‹å®‰å…¨ä¸å¦‚ Prisma**
2. **æŸ¥è¯¢è¯­æ³•ç›¸å¯¹å¤æ‚**
3. **éœ€è¦æ‰‹åŠ¨å¤„ç†ä¸€äº›ç»†èŠ‚**

### **å®æ–½æ­¥éª¤ï¼š**

1. **ä¿®å¤æ•°æ®åº“è¡¨ç»“æ„** (è®¾ç½®é»˜è®¤å€¼)
2. **ä¼˜åŒ–ç°æœ‰ä»£ç ** (ç®€åŒ–æŸ¥è¯¢)
3. **åˆ›å»ºæœåŠ¡ç±»** (æé«˜ä»£ç å¤ç”¨)
4. **æ·»åŠ ç±»å‹å®šä¹‰** (æé«˜ç±»å‹å®‰å…¨)

## ğŸ¤” **æœ€ç»ˆå»ºè®®**

**å¦‚æœæ‚¨æƒ³è¦ç®€å•ç»Ÿä¸€ï¼š**

- é€‰æ‹© **çº¯ Supabase** æ–¹æ¡ˆ
- ä¿®å¤æ•°æ®åº“é…ç½®
- ä¼˜åŒ–æŸ¥è¯¢è¯­æ³•
- åˆ›å»ºæœåŠ¡ç±»å°è£…

**å¦‚æœæ‚¨æƒ³è¦æœ€ä½³å¼€å‘ä½“éªŒï¼š**

- é€‰æ‹© **æ··åˆä½¿ç”¨** æ–¹æ¡ˆ
- è®¤è¯ç”¨ Supabase
- æ•°æ®æ“ä½œç”¨ Prisma

æ‚¨å€¾å‘äºå“ªç§æ–¹æ¡ˆï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨å®æ–½å…·ä½“çš„ä»£ç ä¿®æ”¹ã€‚
