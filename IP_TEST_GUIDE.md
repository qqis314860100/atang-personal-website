# 🌐 IP 地址测试指南

## 📋 概述

这个指南帮助你测试聊天室的多 IP 用户功能，验证不同 IP 地址的用户是否能正确显示和区分。

## 🚀 快速开始

### 1. 启动 Socket 服务器

```bash
npm run socket
```

### 2. 测试单个 IP

```bash
# 测试默认IP (192.168.1.100)
node test-single-ip.js

# 测试指定IP
node test-single-ip.js 10.0.0.50 "用户B"

# 测试公网IP
node test-single-ip.js 8.8.8.8 "Google用户"
```

### 3. 测试多个 IP

```bash
# 运行多IP模拟测试
node test-multi-ip.js
```

## 📝 测试脚本说明

### test-single-ip.js

- **用途**: 模拟单个 IP 地址的用户
- **参数**:
  - 第 1 个参数: IP 地址 (可选，默认: 192.168.1.100)
  - 第 2 个参数: 用户名 (可选，默认: 测试用户)
- **功能**: 连接服务器，发送测试消息，显示接收到的所有事件

### test-multi-ip.js

- **用途**: 同时模拟多个不同 IP 的用户
- **功能**:
  - 创建 8 个不同 IP 的用户连接
  - 随机发送消息
  - 模拟用户加入/离开
  - 显示所有用户的活动

## 🎯 测试场景

### 场景 1: 基本 IP 测试

```bash
# 终端1: 启动服务器
npm run socket

# 终端2: 测试IP 192.168.1.100
node test-single-ip.js 192.168.1.100 "用户A"

# 终端3: 测试IP 10.0.0.50
node test-single-ip.js 10.0.0.50 "用户B"
```

### 场景 2: 公网 IP 测试

```bash
# 测试不同的公网IP
node test-single-ip.js 8.8.8.8 "Google用户"
node test-single-ip.js 1.1.1.1 "Cloudflare用户"
node test-single-ip.js 114.114.114.114 "114DNS用户"
```

### 场景 3: 多用户压力测试

```bash
# 同时运行多个用户
node test-multi-ip.js
```

## 📊 预期结果

### 服务器日志应该显示:

```
🎯 准备初始化用户: 192.168.1.100
🚀 开始初始化用户: 192.168.1.100
📍 IP详细信息: { ip: '192.168.1.100', country: 'Unknown', ... }
✅ IP信息发送完成: 192.168.1.100
🔄 IP信息获取完成，用户: 192.168.1.100，开始加入聊天室
用户 192.168.1.100 加入聊天室，当前在线: 1
✅ 用户加入完成: 192.168.1.100
```

### 客户端应该显示:

```
📍 收到IP信息: { ip: '192.168.1.100', info: {...}, formatted: '192.168.1.100' }
👥 在线用户列表: 1 个用户
📊 在线用户数量: 1
💬 收到消息: 192.168.1.100: 来自 192.168.1.100 的测试消息
```

## 🔧 故障排除

### 问题 1: 连接失败

```bash
# 检查服务器是否运行
curl http://localhost:3001/health

# 检查端口是否被占用
netstat -ano | findstr :3001
```

### 问题 2: IP 显示为 localhost

- 检查 `extraHeaders` 是否正确设置
- 确认服务器端的 IP 获取逻辑

### 问题 3: 用户数量不正确

- 检查 `onlineUsers` Map 的使用
- 确认用户加入/离开逻辑

## 📈 性能测试

### 并发用户测试

```bash
# 创建多个终端，同时运行不同IP的测试
# 终端1
node test-single-ip.js 192.168.1.100 "用户1"

# 终端2
node test-single-ip.js 192.168.1.101 "用户2"

# 终端3
node test-single-ip.js 192.168.1.102 "用户3"
```

### 消息压力测试

- 使用 `test-multi-ip.js` 脚本
- 观察服务器性能和内存使用
- 检查消息广播是否正常

## 🎨 自定义测试

### 修改测试 IP 列表

编辑 `test-multi-ip.js` 中的 `mockUsers` 数组:

```javascript
const mockUsers = [
  { ip: '你的IP1', name: '自定义用户1' },
  { ip: '你的IP2', name: '自定义用户2' },
  // 添加更多IP...
]
```

### 修改测试消息

编辑 `test-multi-ip.js` 中的 `messages` 数组:

```javascript
const messages = [
  '你的测试消息1',
  '你的测试消息2',
  // 添加更多消息...
]
```

## 📝 注意事项

1. **IP 地址格式**: 确保使用有效的 IP 地址格式
2. **服务器状态**: 确保 Socket 服务器正在运行
3. **网络环境**: 本地测试时 IP 可能显示为 localhost
4. **并发限制**: 避免同时创建过多连接
5. **资源清理**: 测试完成后记得关闭连接

## 🆘 获取帮助

如果遇到问题，请检查:

1. 服务器日志输出
2. 客户端连接状态
3. 网络连接情况
4. 防火墙设置
